<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Data Galian 2026</title>
    <!-- Memuat Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        
        .sticky-col-left {
            position: sticky;
            left: 0;
            z-index: 10; 
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen bg-slate-50 text-slate-800">
        <!-- Konten akan dirender oleh JavaScript -->
    </div>

    <script>
        // --- DATA AWAL ---
        const MONTHS = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        const CURRENT_YEAR = 2026; 

        const initialSpreadsheets = [
            { id: 1, name: 'SANDEIR SETIA BROTHERS, PT', url: 'https://docs.google.com/spreadsheets/d/1cZd5YMGppt74xLQeE73_bFJjJnWq8zQ-/edit?usp=sharing' },
            { id: 2, name: 'HERO PROGRES INTERNATIONAL, PT', url: 'https://docs.google.com/spreadsheets/d/1dRXXME_3KLHJlKItPvpX8wWYmDNKhHh6/edit?usp=drive_link' },
            { id: 3, name: 'DUA SATU, CV', url: 'https://docs.google.com/spreadsheets/d/1yZd7TqwcJlXuqO3NYNJGNuti-t_XIqBo/edit?usp=drive_link' },
            { id: 4, name: 'IRPAU HERO, CV', url: 'https://docs.google.com/spreadsheets/d/1vREAz0voPQhNtu6nDpwB6jTmsfYkzKWD/edit?usp=drive_link' },
            { id: 5, name: 'ANEKA KAOLIN UTAMA, PT', url: 'https://docs.google.com/spreadsheets/d/1cykgguFynewBtrDO31FLJdRxxO8Vo6jU/edit?usp=drive_link' },
            { id: 6, name: 'SRIYUDI GLOBALINDO PERKASA, PT', url: 'https://docs.google.com/spreadsheets/d/1xjGXD-CNigtMNesfIrDUXwamommh2uQe/edit?usp=drive_link' },
            { id: 7, name: 'SRIYUDI ALAM PERKASA, PT', url: 'https://docs.google.com/spreadsheets/d/1Nr3mAHFFtRWvLp6ucQhJTPrROGFfeKc_/edit?usp=drive_link' },
            { id: 8, name: 'IRPAU HERO PROGRES, PT', url: 'https://docs.google.com/spreadsheets/d/12ozlRycnABEo4YczG2CKpUMPitvPlbom/edit?usp=drive_link' },
            { id: 9, name: 'ELYSKA INDO PLANTATION, CV', url: 'https://docs.google.com/spreadsheets/d/1J5oiiXSHxeLsT5Fwv4wR9pGlLE1sRoUP/edit?usp=drive_link' },
            { id: 10, name: 'BUMI SENTOSA PROGRESS, PT', url: 'https://docs.google.com/spreadsheets/d/1mru6fO6H24MuehUgFtrU3sW-DlmtlA1m/edit?usp=drive_link' },
            { id: 11, name: 'SRIYUDI LITAJAYA, CV', url: 'https://docs.google.com/spreadsheets/d/1FC2G_7lzf5OGXVv0NEycDuzXWJp9FZgb/edit?usp=drive_link' },
            { id: 12, name: 'BINTANG PUSPITA BUMI DWIPA, PT', url: 'https://docs.google.com/spreadsheets/d/1oxWMRLrtCWrdChLlMhZNKV5tTdtnECES/edit?usp=drive_link' },
            { id: 13, name: 'MINERAL PUTRA BELITUNG MANDIRI, PT', url: 'https://docs.google.com/spreadsheets/d/1s6pChlP-mfMtFAToY3rqDsk3XW_7kJU-/edit?usp=drive_link' },
            { id: 14, name: 'TUNAS MANDIRI, CV', url: 'https://docs.google.com/spreadsheets/d/12fH7OJelMk6Ph6rCYmV-W2zo3YgC_1Ke/edit?usp=drive_link' },
            { id: 15, name: 'BONANZA, CV', url: 'https://docs.google.com/spreadsheets/d/1aJS56qRmNNwTGFDMnpQobzJbcQtFlnNm/edit?usp=drive_link' },
            { id: 16, name: 'ARYA PRIMA SENTOSA, PT', url: 'https://docs.google.com/spreadsheets/d/1zlnqYHbgQ8otZOjMPnCVqmtiRh6e01uo/edit?usp=drive_link' },
            { id: 17, name: 'KAOLINDO SAKTI PERKASA, PT', url: 'https://docs.google.com/spreadsheets/d/13E2Qu80_BRo2_XdQUPfL6pHaqzcitAyh/edit?usp=drive_link' },
            { id: 18, name: 'KAOLIN BELITUNG UTAMA, PT', url: 'https://docs.google.com/spreadsheets/d/17qwxmwHyk2gVl98rDXF2i25QCspQgq2q/edit?usp=drive_link' },
            { id: 19, name: 'KIAN SUKSES MANDIRI, PT', url: 'https://docs.google.com/spreadsheets/d/1CKCOmmJX7pBy4u1JoQfTjBQouzRVJEvP/edit?usp=drive_link' },
            { id: 20, name: 'XINRUN SUKSES INTERNASIONAL, PT', url: 'https://docs.google.com/spreadsheets/d/1IHOgHD5vw3yktFhtZordWJVrH9v5nuem/edit?usp=drive_link' },
            { id: 21, name: 'USAHA MANDIRI PERSADA, PT', url: 'https://docs.google.com/spreadsheets/d/1NBOGxX2s7a1uNxAyel9Lwx_8pgYVWy0n/edit?usp=drive_link' },
            { id: 22, name: 'ALTER ABADI, PT', url: 'https://docs.google.com/spreadsheets/d/1XE9-HiEoYFJZ17-zPJ8fggHSNJiB177U/edit?usp=drive_link' },
            { id: 23, name: 'PRIMA BUNDIARTA NUSA, PT', url: 'https://docs.google.com/spreadsheets/d/1gd3WbPzsMBeiOlRmCrr9POG06msDFsbl/edit?usp=drive_link' },
            { id: 24, name: 'GARUDA ARTHA RECOURCES, PT', url: 'https://docs.google.com/spreadsheets/d/1j85gZf_DmlQjhSaJFNddnMLPdKegyGH0/edit?usp=drive_link' },
            { id: 25, name: 'ANUGERAH KREATIF MANDIRI, PT', url: 'https://docs.google.com/spreadsheets/d/13WKB07NX8yqQuk9wrYBuY6kZD6qnpd84/edit?usp=drive_link' },
            { id: 26, name: 'JABEL TRI BERSAUDARA, PT', url: 'https://docs.google.com/spreadsheets/d/16BNbQjKIqsb7cLyrtP5qty2_npwGYeM4/edit?usp=drive_link' },
            { id: 27, name: 'NIPPINDO KAOLIN ABADI, PT', url: 'https://docs.google.com/spreadsheets/d/17mSKBuh4K9AZ93yjYm_e7cyiQiyPc7QL/edit?usp=drive_link' },
            { id: 28, name: 'STEPA WIRAUSAHA ADIGUNA, PT', url: 'https://docs.google.com/spreadsheets/d/1DKaBzzQvuLunDi7OlO6WNUq6o0hXRzGj/edit?usp=drive_link' },
        ];

        // --- STATE MANAGEMENT ---
        let state = {
            spreadsheets: initialSpreadsheets,
            searchQuery: '',
            fetchedData: {},
            copiedLink: null,
            newLinkName: '',
            newLinkUrl: '',
            isLoading: false,
            errorMsg: null,
        };

        const setState = (newState) => {
            state = { ...state, ...newState };
            renderApp();
        };

        // --- ICONS (SVG) ---
        const getIcon = (name, classes = 'w-4 h-4') => {
            const icons = {
                FileSpreadsheet: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 20h8"/><path d="M8 16h8"/><path d="M8 12h8"/></svg>`,
                Download: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
                Plus: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`,
                Building2: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18"/><path d="M6 18h2"/><path d="M16 18h2"/><path d="M8 14h8"/><path d="M8 10h8"/><path d="M12 22v-4"/><path d="M8 6h.01"/><path d="M16 6h.01"/></svg>`,
                Search: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`,
                X: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
                CalendarDays: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>`,
                RefreshCw: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.76 2.62M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.76-2.62"/><path d="M3 3v3h3"/><path d="M21 21v-3h-3"/></svg>`,
                AlertTriangle: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="m21.73 18-9-15a.4.4 0 0 0-.74 0l-9 15a.4.4 0 0 0 .37.6H21.36a.4.4 0 0 0 .37-.6Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`,
                Copy: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>`,
                Loader: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="M12 2v4"/><path d="m18 6-2 2"/><path d="M22 12h-4"/><path d="m18 18-2-2"/><path d="M12 22v-4"/><path d="m6 18 2-2"/><path d="M4 12h4"/><path d="m6 6 2 2"/></svg>`,
                ChevronLeft: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="m15 18-6-6 6-6"/></svg>`,
                ChevronRight: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${classes}"><path d="m9 18 6-6-6-6"/></svg>`,
            };
            return icons[name] || '';
        };

        // --- UTILS ---
        const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number || 0);
        const formatVolume = (number) => new Intl.NumberFormat('id-ID').format(number || 0);
        const formatNilaiRb = (number) => new Intl.NumberFormat('id-ID').format(number || 0) + ' Rb';

        const getSpreadsheetId = (url) => {
            const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
        };

        const handleCopyLink = (url, id) => {
            const tempInput = document.createElement('input');
            tempInput.value = url;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            setState({ copiedLink: id });
            setTimeout(() => setState({ copiedLink: null }), 1500);
        };

        const openLink = (url) => window.open(url, '_blank');

        const handleAddSpreadsheet = (e) => {
            e.preventDefault();
            const name = document.getElementById('newLinkName').value.trim();
            const url = document.getElementById('newLinkUrl').value.trim();
            if (name && url) {
                setState({
                    spreadsheets: [...state.spreadsheets, { id: Date.now(), name, url }],
                    newLinkName: '',
                    newLinkUrl: ''
                });
            }
        };

        const handleDeleteSpreadsheet = (id) => {
            setState({ spreadsheets: state.spreadsheets.filter(s => s.id !== id) });
        };

        const handleSearch = (e) => {
            setState({ searchQuery: e.target.value });
        };

        const handleScroll = (direction) => {
            const container = document.getElementById('tableContainer');
            if (container) {
                const amount = container.clientWidth * 0.6;
                container.scrollBy({ left: direction === 'left' ? -amount : amount, behavior: 'smooth' });
            }
        };

        // --- GVIZ FETCH ---
        const fetchMonthlyData = async () => {
            setState({ isLoading: true, errorMsg: null });
            const allFetchedData = {};
            let globalError = '';
            
            await Promise.all(state.spreadsheets.map(async (sheet) => {
                const id = getSpreadsheetId(sheet.url);
                if (!id) return;
                const gvizUrl = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=DataBulanan&tq=SELECT *`;
                try {
                    const response = await fetch(gvizUrl);
                    const text = await response.text();
                    const jsonText = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
                    const gvizResponse = JSON.parse(jsonText);
                    
                    if (gvizResponse.status !== 'ok') throw new Error("Gagal ambil data");
                    
                    const companyData = {};
                    gvizResponse.table.rows.forEach(row => {
                        const r = row.c;
                        const type = r[0]?.v;
                        const metric = r[1]?.v;
                        if (!type || !metric) return;
                        
                        MONTHS.forEach((m, i) => {
                            const rawVal = r[i+2]?.v;
                            const val = (rawVal !== null && rawVal !== undefined) ? Number(rawVal) : null;
                            const key = `${type}_${m} ${CURRENT_YEAR}`;
                            
                            if (!companyData[key]) companyData[key] = { volume: null, nilai: null, type, monthYearKey: `${m} ${CURRENT_YEAR}` };
                            if (String(metric).toLowerCase().includes('vol')) companyData[key].volume = val;
                            else companyData[key].nilai = val;
                        });
                    });
                    allFetchedData[sheet.name] = companyData;
                } catch (e) {
                    globalError += `[${sheet.name}] Periksa izin/URL. `;
                }
            }));
            setState({ fetchedData: allFetchedData, isLoading: false, errorMsg: globalError });
        };

        const generateMonthlyRecap = () => {
            const recaps = [];
            state.spreadsheets.forEach((company, cIdx) => {
                const raw = state.fetchedData[company.name] || {};
                const byType = {};
                
                Object.values(raw).forEach(d => {
                    if (!byType[d.type]) byType[d.type] = { totalVol: 0, totalNil: 0, monthly: {}, hasAnyData: false };
                    
                    if (d.volume !== null) {
                        byType[d.type].totalVol += d.volume;
                        byType[d.type].hasAnyData = true;
                    }
                    if (d.nilai !== null) {
                        byType[d.type].totalNil += d.nilai;
                        byType[d.type].hasAnyData = true;
                    }
                    byType[d.type].monthly[d.monthYearKey] = { volume: d.volume, nilai: d.nilai };
                });
                
                const types = Object.keys(byType);
                if (types.length === 0) {
                    recaps.push({ id: company.id, name: company.name, type: 'No Data', totalVol: 0, totalNil: 0, monthly: {}, cIdx, isGlobalEmpty: true });
                } else {
                    types.forEach(t => recaps.push({ 
                        id: `${company.id}-${t}`, 
                        name: company.name, 
                        type: t, 
                        totalVol: byType[t].totalVol, 
                        totalNil: byType[t].totalNil, 
                        monthly: byType[t].monthly, 
                        cIdx, 
                        isGlobalEmpty: !byType[t].hasAnyData 
                    }));
                }
            });
            return recaps;
        };

        const downloadCSV = () => {
            const recaps = generateMonthlyRecap();
            const monthHeader = MONTHS.flatMap(m => [`${m} Vol`, `${m} Nil`]).join(',');
            const header = `Lokasi,Jenis,Total Vol,Total Nil,${monthHeader}`;
            const rows = recaps.map(r => {
                const mData = MONTHS.flatMap(m => {
                    const d = r.monthly ? r.monthly[`${m} ${CURRENT_YEAR}`] : null;
                    return [d?.volume ?? '', d?.nilai ?? ''];
                }).join(',');
                return `"${r.name}","${r.type}",${r.totalVol},${r.totalNil * 1000},${mData}`;
            }).join('\n');
            const blob = new Blob([header + '\n' + rows], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `rekap_produksi_galian_${CURRENT_YEAR}.csv`;
            link.click();
        };

        // --- RENDER ---
        const renderApp = () => {
            const app = document.getElementById('app');
            if (!app) return;

            const filteredSpreadsheets = state.spreadsheets.filter(s => s.name.toLowerCase().includes(state.searchQuery.toLowerCase()));
            const recaps = generateMonthlyRecap();

            app.innerHTML = `
                <nav class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
                    <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <div class="bg-emerald-600 p-2 rounded-lg text-white">${getIcon('FileSpreadsheet', 'w-6 h-6')}</div>
                            <div>
                                <h1 class="text-xl font-bold text-slate-800 tracking-tight">Dashboard Data Galian 2026</h1>
                                <p class="text-xs text-slate-500 font-medium italic">Kabupaten Belitung</p>
                            </div>
                        </div>
                    </div>
                </nav>

                <main class="max-w-7xl mx-auto px-4 py-8">
                    ${state.errorMsg ? `<div class="mb-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg flex gap-2">${getIcon('AlertTriangle', 'w-5 h-5')}<p class="text-sm">${state.errorMsg}</p></div>` : ''}

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                                    <h2 class="font-bold text-slate-700 flex items-center gap-2">${getIcon('Building2', 'w-5 h-5 text-emerald-600')} Daftar Perusahaan</h2>
                                    <span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-bold">${filteredSpreadsheets.length} List</span>
                                </div>
                                <div class="p-3 bg-white border-b border-slate-100">
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">${getIcon('Search', 'w-4 h-4')}</div>
                                        <input type="text" placeholder="Cari perusahaan..." class="w-full pl-9 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 focus:outline-none" value="${state.searchQuery}" oninput="handleSearch(event)"/>
                                    </div>
                                </div>
                                <div class="max-h-[400px] overflow-y-auto p-3 space-y-2 custom-scroll">
                                    ${filteredSpreadsheets.map(s => `
                                        <div class="group flex items-center justify-between p-2 rounded-lg border border-slate-100 bg-slate-50 hover:bg-emerald-50 transition-all">
                                            <button onclick="openLink('${s.url}')" class="flex-1 text-left min-w-0 pr-2">
                                                <div class="text-sm font-bold text-slate-700 truncate">${s.name}</div>
                                                <div class="text-[10px] text-slate-400 truncate">${s.url}</div>
                                            </button>
                                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onclick="handleCopyLink('${s.url}', ${s.id})" class="p-1.5 text-slate-400 hover:text-emerald-600 hover:bg-white rounded transition-all">${getIcon('Copy', 'w-4 h-4')}</button>
                                                <button onclick="handleDeleteSpreadsheet(${s.id})" class="p-1.5 text-slate-400 hover:text-red-600 hover:bg-white rounded transition-all">${getIcon('X', 'w-4 h-4')}</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="p-4 bg-slate-50 border-t border-slate-200">
                                    <form onsubmit="handleAddSpreadsheet(event)" class="space-y-3">
                                        <input type="text" id="newLinkName" placeholder="Nama Perusahaan Baru" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm" required />
                                        <input type="url" id="newLinkUrl" placeholder="URL Spreadsheet" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm" required />
                                        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg text-sm font-bold transition-all flex justify-center items-center gap-2">
                                            ${getIcon('Plus', 'w-4 h-4')} Tambah
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div class="p-5 border-b border-slate-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                    <div>
                                        <h2 class="font-bold text-slate-800 flex items-center gap-2">${getIcon('CalendarDays', 'w-5 h-5 text-blue-500')} Rekap Produksi 2026</h2>
                                        
                                        <!-- KETERANGAN WARNA -->
                                        <div class="mt-4 flex flex-wrap gap-4 items-center">
                                            <div class="flex items-center gap-1.5 text-[10px] font-semibold bg-slate-50 px-2 py-1 rounded-md border border-slate-100">
                                                <span class="w-3 h-3 bg-red-100 border border-red-300 rounded-sm"></span>
                                                <span class="text-slate-600">Data Belum Diisi</span>
                                            </div>
                                            <div class="flex items-center gap-1.5 text-[10px] font-semibold bg-slate-50 px-2 py-1 rounded-md border border-slate-100">
                                                <span class="w-3 h-3 bg-white border border-slate-300 rounded-sm"></span>
                                                <span class="text-slate-600">Data Terisi</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 w-full sm:w-auto self-start sm:self-center">
                                        <button onclick="fetchMonthlyData()" class="flex-1 sm:flex-none flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all">
                                            ${state.isLoading ? getIcon('Loader', 'w-4 h-4 animate-spin') : getIcon('RefreshCw', 'w-4 h-4')} Refresh
                                        </button>
                                        <button onclick="downloadCSV()" class="flex-1 sm:flex-none flex items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg text-sm font-bold border border-slate-200 transition-all">
                                            ${getIcon('Download', 'w-4 h-4')} CSV
                                        </button>
                                    </div>
                                </div>

                                <div class="flex justify-between items-center px-5 py-2 bg-slate-50 border-b border-slate-200">
                                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Detail Produksi Perusahaan Galian</span>
                                    <div class="flex gap-1">
                                        <button onclick="handleScroll('left')" class="p-1 bg-white border border-slate-200 rounded text-slate-500 hover:bg-blue-50">${getIcon('ChevronLeft', 'w-4 h-4')}</button>
                                        <button onclick="handleScroll('right')" class="p-1 bg-white border border-slate-200 rounded text-slate-500 hover:bg-blue-50">${getIcon('ChevronRight', 'w-4 h-4')}</button>
                                    </div>
                                </div>

                                <div id="tableContainer" class="overflow-x-auto relative custom-scroll min-h-[400px]">
                                    ${state.isLoading ? `<div class="absolute inset-0 flex flex-col items-center justify-center bg-white/80 z-20">${getIcon('Loader', 'w-10 h-10 text-blue-600 animate-spin mb-2')}<p class="text-sm font-bold text-slate-600">Sinkronisasi...</p></div>` : ''}
                                    <table class="w-full text-left text-xs border-collapse">
                                        <thead class="bg-slate-100 text-slate-600 font-bold sticky top-0 z-10 border-b border-slate-200">
                                            <tr>
                                                <th rowspan="2" class="px-3 py-4 sticky-col-left bg-slate-100 border-r border-slate-200 z-20 min-w-[180px]">Lokasi Galian</th>
                                                <th rowspan="2" class="px-3 py-4 text-center border-r border-slate-200 bg-blue-50/50">Jenis</th>
                                                <th rowspan="2" class="px-3 py-4 text-center border-r border-slate-200 bg-emerald-50/50">Total Vol</th>
                                                <th rowspan="2" class="px-3 py-4 text-center border-r border-slate-200 bg-indigo-50/50">Total Nilai</th>
                                                ${MONTHS.map(m => `<th colspan="2" class="px-2 py-2 text-center border-r border-slate-200 bg-slate-50">${m}</th>`).join('')}
                                            </tr>
                                            <tr class="bg-slate-50">
                                                ${MONTHS.map(() => `<th class="px-2 py-2 text-center border-r border-slate-100 text-emerald-600 font-normal">Vol</th><th class="px-2 py-2 text-center border-r border-slate-200 text-indigo-600 font-normal">Nil</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${recaps.map((r) => {
                                                const isGlobalEmpty = !!r.isGlobalEmpty;
                                                return `
                                                <tr class="border-b border-slate-100 hover:bg-blue-50/30 transition-colors">
                                                    <td class="px-3 py-3 font-bold text-slate-700 sticky-col-left bg-white border-r border-slate-100 ${isGlobalEmpty ? 'border-l-4 border-l-red-500' : ''}">
                                                        ${r.name}
                                                        ${isGlobalEmpty ? '<span class="block text-[8px] text-red-500 font-normal">Data belum diinput</span>' : ''}
                                                    </td>
                                                    <td class="px-3 py-3 text-center border-r border-slate-100 text-slate-500 italic">${r.type}</td>
                                                    <td class="px-3 py-3 text-center font-bold text-emerald-700 border-r border-slate-100 bg-emerald-50/10">${formatVolume(r.totalVol)}</td>
                                                    <td class="px-3 py-3 text-center font-bold text-indigo-700 border-r border-slate-200 bg-indigo-50/10">${formatRupiah(r.totalNil * 1000)}</td>
                                                    ${MONTHS.map(m => {
                                                        const d = r.monthly ? r.monthly[`${m} ${CURRENT_YEAR}`] : null;
                                                        const isVolNull = !d || d.volume === null;
                                                        const isNilNull = !d || d.nilai === null;
                                                        
                                                        return `
                                                            <td class="px-1 py-3 text-center border-r border-slate-50 ${isVolNull ? 'bg-red-50' : 'text-emerald-600/80'}">
                                                                ${isVolNull ? '' : formatVolume(d.volume)}
                                                            </td>
                                                            <td class="px-1 py-3 text-center border-r border-slate-100 ${isNilNull ? 'bg-red-50' : 'text-indigo-600/80'}">
                                                                ${isNilNull ? '' : formatNilaiRb(d.nilai)}
                                                            </td>
                                                        `;
                                                    }).join('')}
                                                </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            `;
        };

        window.onload = () => { renderApp(); fetchMonthlyData(); };
    </script>
</body>
</html>

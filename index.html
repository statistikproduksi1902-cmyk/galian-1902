import React, { useState, useMemo, useEffect, useRef } from 'react';
import { 
  FileSpreadsheet, 
  Download, 
  Plus,
  Building2,
  X,
  CalendarDays,
  RefreshCw,
  AlertTriangle,
  Copy,
  Loader,
  ChevronLeft,
  ChevronRight
} from 'lucide-react';

// Daftar nama bulan dalam Bahasa Indonesia
const MONTHS = [
    'Januari', 'Februari', 'Maret', 'April', 
    'Mei', 'Juni', 'Juli', 'Agustus', 
    'September', 'Oktober', 'November', 'Desember'
];

export default function App() {
  const CURRENT_YEAR = new Date().getFullYear();

  // Ref untuk elemen yang dapat di-scroll (tabel)
  const tableContainerRef = useRef(null);

  // State untuk daftar Spreadsheet Galian (daftar perusahaan target)
  const [spreadsheets, setSpreadsheets] = useState([
    // CATATAN PENTING: Untuk data real time, spreadsheet ini harus dibagikan secara publik.
    // Gunakan struktur spreadsheet BARU (Kolom A: Jenis Galian, B: Metrik (Volume/Nilai), C-N: Bulan)
    { id: 1, name: 'SANDEIR SETIA BROTHERS, PT', url: 'https://docs.google.com/spreadsheets/d/1cZd5YMGppt74xLQeE73_bFJjJnWq8zQ-/edit?usp=sharing&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 2, name: 'HERO PROGRES INTERNATIONAL, PT', url: 'https://docs.google.com/spreadsheets/d/1dRXXME_3KLHJlKItPvpX8wWYmDNKhHh6/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 3, name: 'DUA SATU, CV', url: 'https://docs.google.com/spreadsheets/d/1yZd7TqwcJlXuqO3NYNJGNuti-t_XIqBo/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 4, name: 'IRPAU HERO, CV', url: 'https://docs.google.com/spreadsheets/d/1vREAz0voPQhNtu6nDpwB6jTmsfYkzKWD/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 5, name: 'ANEKA KAOLIN UTAMA, PT', url: 'https://docs.google.com/spreadsheets/d/1cykgguFynewBtrDO31FLJdRxxO8Vo6jU/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 6, name: 'SRIYUDI GLOBALINDO PERKASA, PT', url: 'https://docs.google.com/spreadsheets/d/1xjGXD-CNigtMNesfIrDUXwamommh2uQe/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 7, name: 'SRIYUDI ALAM PERKASA, PT', url: 'https://docs.google.com/spreadsheets/d/1Nr3mAHFFtRWvLp6ucQhJTPrROGFfeKc_/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 8, name: 'IRPAU HERO PROGRES, PT', url: 'https://docs.google.com/spreadsheets/d/12ozlRycnABEo4YczG2CKpUMPitvPlbom/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 9, name: 'ELYSKA INDO PLANTATION, CV', url: 'https://docs.google.com/spreadsheets/d/1J5oiiXSHxeLsT5Fwv4wR9pGlLE1sRoUP/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 10, name: 'BUMI SENTOSA PROGRESS, PT', url: 'https://docs.google.com/spreadsheets/d/1mru6fO6H24MuehUgFtrU3sW-DlmtlA1m/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 11, name: 'SRIYUDI LITAJAYA, CV', url: 'https://docs.google.com/spreadsheets/d/1FC2G_7lzf5OGXVv0NEycDuzXWJp9FZgb/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 12, name: 'BINTANG PUSPITA BUMI DWIPA, PT', url: 'https://docs.google.com/spreadsheets/d/1oxWMRLrtCWrdChLlMhZNKV5tTdtnECES/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 13, name: 'MINERAL PUTRA BELITUNG MANDIRI, PT', url: 'https://docs.google.com/spreadsheets/d/1s6pChlP-mfMtFAToY3rqDsk3XW_7kJU-/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 14, name: 'TUNAS MANDIRI, CV', url: 'https://docs.google.com/spreadsheets/d/12fH7OJelMk6Ph6rCYmV-W2zo3YgC_1Ke/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 15, name: 'BONANZA, CV', url: 'https://docs.google.com/spreadsheets/d/1aJS56qRmNNwTGFDMnpQobzJbcQtFlnNm/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 16, name: 'ARYA PRIMA SENTOSA, PT', url: 'https://docs.google.com/spreadsheets/d/1zlnqYHbgQ8otZOjMPnCVqmtiRh6e01uo/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 17, name: 'KAOLINDO SAKTI PERKASA, PT', url: 'https://docs.google.com/spreadsheets/d/13E2Qu80_BRo2_XdQUPfL6pHaqzcitAyh/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 18, name: 'KAOLIN BELITUNG UTAMA, PT', url: 'https://docs.google.com/spreadsheets/d/17qwxmwHyk2gVl98rDXF2i25QCspQgq2q/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 19, name: 'KIAN SUKSES MANDIRI, PT', url: 'https://docs.google.com/spreadsheets/d/1CKCOmmJX7pBy4u1JoQfTjBQouzRVJEvP/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 20, name: 'XINRUN SUKSES INTERNASIONAL, PT', url: 'https://docs.google.com/spreadsheets/d/1IHOgHD5vw3yktFhtZordWJVrH9v5nuem/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 21, name: 'USAHA MANDIRI PERSADA, PT', url: 'https://docs.google.com/spreadsheets/d/1NBOGxX2s7a1uNxAyel9Lwx_8pgYVWy0n/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 22, name: 'ALTER ABADI, PT', url: 'https://docs.google.com/spreadsheets/d/1XE9-HiEoYFJZ17-zPJ8fggHSNJiB177U/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 23, name: 'PRIMA BUNDIARTA NUSA, PT', url: 'https://docs.google.com/spreadsheets/d/1gd3WbPzsMBeiOlRmCrr9POG06msDFsbl/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 24, name: 'GARUDA ARTHA RECOURCES, PT', url: 'https://docs.google.com/spreadsheets/d/1j85gZf_DmlQjhSaJFNddnMLPdKegyGH0/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 25, name: 'ANUGERAH KREATIF MANDIRI, PT', url: 'https://docs.google.com/spreadsheets/d/13WKB07NX8yqQuk9wrYBuY6kZD6qnpd84/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 26, name: 'JABEL TRI BERSAUDARA, PT', url: 'https://docs.google.com/spreadsheets/d/16BNbQjKIqsb7cLyrtP5qty2_npwGYeM4/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 27, name: 'NIPPINDO KAOLIN ABADI, PT', url: 'https://docs.google.com/spreadsheets/d/17mSKBuh4K9AZ93yjYm_e7cyiQiyPc7QL/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
    { id: 28, name: 'STEPA WIRAUSAHA ADIGUNA, PT', url: 'https://docs.google.com/spreadsheets/d/1DKaBzzQvuLunDi7OlO6WNUq6o0hXRzGj/edit?usp=drive_link&ouid=101955590298878340993&rtpof=true&sd=true' },
  ]);
  
  const [logEntries, setLogEntries] = useState([]);
  const [fetchedData, setFetchedData] = useState({});
  const [copiedLink, setCopiedLink] = useState(null); 
  const [newLinkName, setNewLinkName] = useState('');
  const [newLinkUrl, setNewLinkNameUrl] = useState('');
  const [isLoading, setIsLoading] = useState(false); 
  const [errorMsg, setErrorMsg] = useState(null);

  // --- Initial Data Fetch ---
  useEffect(() => {
    // Muat data saat komponen dimuat pertama kali
    if (spreadsheets.length > 0) {
      fetchMonthlyData();
    }
  }, []); 

  // --- FUNGSI PENGAMBILAN DATA (MENGGUNAKAN GVIZ/TQ) ---
  const fetchMonthlyData = async () => {
    
    setIsLoading(true);
    setErrorMsg(null);
    // CATATAN: Struktur spreadsheet diubah menjadi Long Format (Volume/Nilai di kolom B sebagai Metrik)
    const allFetchedData = {};

    // Fungsi untuk mendapatkan ID dari URL
    const getSpreadsheetId = (url) => {
        const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
        return match ? match[1] : null;
    };
    
    const fetchPromises = spreadsheets.map(async (sheet) => {
        const id = getSpreadsheetId(sheet.url);
        
        // Lewati jika ID tidak valid (seperti mock_id)
        if (!id || id.startsWith('mock_id')) {
            console.warn(`Melewatkan Spreadsheet ${sheet.name}: ID tidak valid/mock.`);
            allFetchedData[sheet.name] = {};
            return;
        }

        // Endpoint Google Visualization Query (gviz/tq)
        // Memastikan sheet yang diambil adalah 'DataBulanan'
        const gvizUrl = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=DataBulanan&tq=SELECT *`;
        
        try {
            console.log(`Mengambil data untuk ${sheet.name} dari: ${gvizUrl}`);
            const response = await fetch(gvizUrl);
            const text = await response.text();

            // 1. Membersihkan string respons dari wrapper JSONP:
            const jsonpWrapper = 'google.visualization.Query.setResponse(';
            const startIndex = text.indexOf(jsonpWrapper) + jsonpWrapper.length;
            const endIndex = text.lastIndexOf(');');
            
            if (startIndex === -1 || endIndex === -1) {
                throw new Error("Format respons Gviz tidak valid. Pastikan Spreadsheet dibagikan secara publik.");
            }
            
            const jsonText = text.substring(startIndex, endIndex);
            const gvizResponse = JSON.parse(jsonText);

            if (gvizResponse.status !== 'ok') {
                // Memberikan pesan kesalahan yang lebih spesifik jika status bukan 'ok'
                throw new Error(`Gagal mengambil data: ${gvizResponse.errors?.[0]?.message || 'Pastikan nama sheet adalah DataBulanan.'}`);
            }

            // companyData akan menyimpan data yang telah di-pivot (Horizontal)
            const companyData = {}; 
            const table = gvizResponse.table;

            // PENTING: Gviz API secara otomatis menginterpretasikan baris pertama (Row 1) sebagai header
            // sehingga 'table.rows' hanya berisi baris data yang valid (dimulai dari Row 2 di Spreadsheet).
            table.rows.forEach(row => {
                const rowData = row.c; // Array of cells
                
                // ASUMSI: 0=JenisGalian (Kolom A), 1=Metrik (Volume/Nilai - Kolom B), 2=Jan (Kolom C), ...
                const galianType = rowData[0]?.v; // Index 0 (Kolom A)
                const metricType = rowData[1]?.v; // Index 1 (Kolom B)

                if (!galianType || !metricType) return; // Lewati baris tanpa Jenis Galian atau Metrik

                
                MONTHS.forEach((month, monthIndex) => {
                    // Index data bulan dimulai dari 2 (Kolom C = Januari)
                    const monthCellIndex = monthIndex + 2; 
                    const monthCell = rowData[monthCellIndex]; 
                    
                    const value = Number(monthCell?.v) || 0;
                    
                    if (value >= 0) { // Izinkan 0 untuk dicatat jika ada data
                        const monthYearKey = `${month} ${CURRENT_YEAR}`;
                        const uniqueKey = `${galianType}_${monthYearKey}`;
                        
                        // Inisialisasi struktur data pivot
                        if (!companyData[uniqueKey]) {
                            companyData[uniqueKey] = {
                                volume: 0,
                                nilai: 0,
                                type: galianType, 
                                monthYearKey: monthYearKey
                            };
                        }
                        
                        // Mengisi Volume atau Nilai berdasarkan kolom Metrik (Kolom B)
                        if (String(metricType).toLowerCase().includes('volume')) {
                            companyData[uniqueKey].volume = value;
                        } else if (String(metricType).toLowerCase().includes('nilai') || String(metricType).toLowerCase().includes('value')) {
                            companyData[uniqueKey].nilai = value;
                        }
                    }
                });
            });

            allFetchedData[sheet.name] = companyData;
            console.log(`Data untuk ${sheet.name} berhasil dimuat.`);

        } catch (error) {
            // Memberikan pesan kesalahan yang lebih spesifik jika kegagalan terjadi
            const isPermissionError = error.message.includes('Format respons Gviz tidak valid') || error.message.includes('Gagal mengambil data');
            const errorMessage = isPermissionError 
                ? "Gagal mengakses data. Pastikan tautan Google Sheets valid, nama sheet adalah 'DataBulanan', dan Spreadsheet telah dibagikan publik (Anyone with the link can view)."
                : error.message;

            console.error(`Gagal memuat data dari ${sheet.name} (${sheet.url}):`, error.message);
            // Tambahkan data gagal sebagai kosong
            allFetchedData[sheet.name] = {};
            setErrorMsg(prev => (prev || '') + `[${sheet.name}] Gagal: ${errorMessage}. `);
        }
    });

    await Promise.all(fetchPromises);
    
    // Simpan semua data yang berhasil dimuat
    setFetchedData(allFetchedData);
    
    setIsLoading(false);
  };

  // --- LOGIKA REKAP BULANAN ---
  const monthlyRecap = useMemo(() => {
    const allRecaps = [];

    // Gunakan index dari array spreadsheets untuk menentukan grup visual (grup ganjil/genap)
    spreadsheets.forEach((company, companyIndex) => {
        const rawData = fetchedData[company.name] || {};
        const companyDataByType = {}; 

        // 1. Kelompokkan data mentah (raw data) berdasarkan Jenis Galian
        Object.keys(rawData).forEach(uniqueKey => {
            const data = rawData[uniqueKey];
            
            // Periksa jika data valid dan memiliki jenis
            if (!data || typeof data.type === 'undefined' || data.type === null) return; 

            const type = data.type || 'Lain-lain'; 
            const monthYearKey = data.monthYearKey || uniqueKey.split('_')[1]; 

            if (!companyDataByType[type]) {
                companyDataByType[type] = {
                    totalVolume: 0,
                    totalNilai: 0,
                    monthlyData: {},
                };
            }

            // Pastikan volume dan nilai adalah angka sebelum menambahkan
            const volumeToAdd = Number(data.volume) || 0;
            const nilaiToAdd = Number(data.nilai) || 0;

            companyDataByType[type].totalVolume += volumeToAdd;
            companyDataByType[type].totalNilai += nilaiToAdd;
            
            companyDataByType[type].monthlyData[monthYearKey] = {
                volume: volumeToAdd,
                nilai: nilaiToAdd,
                status: 'Sudah',
            };
        });
        
        const uniqueTypes = Object.keys(companyDataByType); 
        
        if (uniqueTypes.length === 0) {
            // Jika tidak ada data, buat satu baris 'Belum Ada Data'
             const companyRecap = {
                id: `${company.id}-NoData`, 
                name: company.name,
                type: 'Belum Ada Data',
                totalVolume: 0,
                totalNilai: 0,
                companyIndex: companyIndex, // Tambahkan index grup
                // Pastikan 12 bulan terisi dengan status 'Belum Ada Data'
                monthlyData: MONTHS.reduce((acc, month) => {
                    acc[`${month} ${CURRENT_YEAR}`] = { status: 'Belum Ada Data', volume: 0, nilai: 0 };
                    return acc;
                }, {}),
            };
            allRecaps.push(companyRecap);

        } else {
            // 2. Buat objek rekapitulasi akhir untuk setiap Jenis Galian
            uniqueTypes.forEach(type => {
                const typeRecap = companyDataByType[type];
                
                const companyRecap = {
                    id: `${company.id}-${type}`, // ID unik untuk key React
                    name: company.name,
                    type: type,
                    totalVolume: typeRecap.totalVolume,
                    totalNilai: typeRecap.totalNilai,
                    monthlyData: {}, // Map baru untuk 12 bulan
                    companyIndex: companyIndex, // Tambahkan index grup
                };

                // Isi 12 bulan (menggunakan data yang sudah difetch atau default)
                MONTHS.forEach(month => {
                    const monthYearKey = `${month} ${CURRENT_YEAR}`;
                    const monthlyData = typeRecap.monthlyData[monthYearKey];
                    
                    if (monthlyData) {
                        companyRecap.monthlyData[monthYearKey] = monthlyData;
                    } else {
                        // Data default jika bulan tersebut belum ada data
                        companyRecap.monthlyData[monthYearKey] = { status: 'Belum Ada Data', volume: 0, nilai: 0 };
                    }
                });
                
                allRecaps.push(companyRecap);
            });
        }
    });

    return allRecaps;
  }, [spreadsheets, fetchedData, CURRENT_YEAR]);

  // --- UTILITY FUNCTIONS ---
  // Fungsi untuk menggeser tabel secara horizontal
  const handleScroll = (direction) => {
    const container = tableContainerRef.current;
    if (container) {
        // Geser setengah lebar container
        const scrollAmount = container.clientWidth * 0.6; 
        
        if (direction === 'left') {
            container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        } else if (direction === 'right') {
            container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
    }
  };

  const formatRupiah = (number) => {
    // Memastikan angka yang diformat adalah number
    const num = Number(number) || 0; 
    return new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0
    }).format(num);
  };
  
  const formatVolume = (number) => {
    const num = Number(number) || 0; 
    return new Intl.NumberFormat('id-ID').format(num);
  };
  
  // FUNGSI DIPERBARUI: Format Nilai dalam Ribu Rupiah (Rb)
  const formatNilaiRb = (number) => {
      const num = Number(number) || 0;
      // Num 0 akan tetap menghasilkan '0 Rb'
      return new Intl.NumberFormat('id-ID', {
          maximumFractionDigits: 0,
          minimumFractionDigits: 0
      }).format(num) + ' Rb';
  };

  const handleAddSpreadsheet = (e) => {
    e.preventDefault();
    if (newLinkName && newLinkUrl) {
      const newName = newLinkName; 
      
      setSpreadsheets(prev => [...prev, {
        id: Date.now(),
        name: newName,
        url: newLinkUrl
      }]);
      
      // Inisialisasi data untuk perusahaan baru 
      setFetchedData(prevData => ({
          ...prevData,
          [newName]: {}
      }));

      setNewLinkName('');
      setNewLinkNameUrl('');
    }
  };

  const handleDeleteSpreadsheet = (id) => {
    setSpreadsheets(spreadsheets.filter(s => s.id !== id));
  };

  const handleCopyLink = (url, id) => {
    const tempInput = document.createElement('input');
    tempInput.value = url;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);

    setCopiedLink(id);
    setTimeout(() => setCopiedLink(null), 1500);
  };

  const openLink = (url, name) => {
    const now = new Date();
    const monthYear = now.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
    
    const newLog = {
      id: Date.now(),
      companyName: name,
      monthYear: monthYear,
      action: 'Link Accessed',
    };
    
    setLogEntries(prev => [newLog, ...prev]);
    window.open(url, '_blank');
  };
  
  const downloadCSV = () => {
    // Header Level 2 di CSV harus menyesuaikan dengan format kolom Bulanan
    const monthHeadersLevel2 = MONTHS.flatMap(() => ["Volume (Ton)", "Nilai (IDR)"]);
    const mainHeaders = ["Lokasi Galian", "Jenis Galian", "Total Volume (Ton)", "Total Nilai (IDR)"];
    
    // Gabungkan Nama Bulan dengan Metrik
    const monthColumns = MONTHS.flatMap(month => monthHeadersLevel2.map(h => `${month} ${h}`)).join(',');

    const headers = [...mainHeaders, ...monthColumns.split(',')].join(",");
    
    const csvContent = monthlyRecap.map(recap => {
      const rowData = MONTHS.flatMap(month => {
        const data = recap.monthlyData[`${month} ${CURRENT_YEAR}`] || { volume: 0, nilai: 0 }; 
        return [data.volume || 0, data.nilai || 0]; 
      });
      
      const totalVolume = recap.totalVolume || 0;
      const totalNilai = recap.totalNilai || 0;

      return `"${recap.name}","${recap.type}",${totalVolume},${totalNilai},${rowData.join(",")}`;
    }).join("\n");
    
    const blob = new Blob([headers + "\n" + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `rekap_data_galian_detail_${CURRENT_YEAR}.csv`);
    document.body.appendChild(link);
    link.click();
  };


  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans">
      {/* Header / Navbar */}
      <nav className="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16 items-center">
            <div className="flex items-center gap-2">
              <div className="bg-green-600 p-2 rounded-lg text-white">
                <FileSpreadsheet size={24} />
              </div>
              <div>
                <h1 className="text-xl font-bold text-slate-800">Dashboard Data Galian</h1>
                <p className="text-xs text-slate-500">Aplikasi Rekapitulasi</p>
              </div>
            </div>

            <div className="flex items-center gap-3">
              <div className="bg-red-100 p-2 rounded-lg text-red-700 font-medium text-sm hidden md:flex items-center gap-1">
                <AlertTriangle size={16}/> Data menggunakan **Live Data (Gviz)**. Pastikan Spreadsheet target **Dibagikan Publik**.
              </div>
            </div>
          </div>
        </div>
      </nav>
      
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Pesan Kesalahan Global */}
        {errorMsg && (
             <div className="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm flex items-start gap-2">
                <AlertTriangle size={20} className="mt-0.5 min-w-4" />
                <div>
                    <h3 className="font-bold">Kesalahan Pengambilan Data:</h3>
                    <p>{errorMsg}</p>
                    <p className="font-semibold mt-1">Solusi: Pastikan semua link adalah link Google Sheets yang valid, nama sheet adalah 'DataBulanan', dan Spreadsheet telah dibagikan publik ("Anyone with the link").</p>
                </div>
            </div>
        )}
        
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          {/* Kolom Kiri: Manajemen Link Spreadsheet (Target Perusahaan) */}
          <div className="lg:col-span-1">
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
              <div className="p-4 border-b border-slate-100 bg-slate-50">
                <h2 className="font-semibold text-slate-800 flex items-center gap-2">
                  <Building2 size={18} className="text-green-600" />
                  Target Spreadsheet Galian
                </h2>
              </div>
              
              {/* Daftar Link Existing */}
              <div className="p-4">
                <h4 className="text-sm font-medium text-slate-700 mb-3">
                  Klik untuk Membuka & Mencatat Akses ({spreadsheets.length})
                </h4>
                <div className="space-y-2 max-h-64 overflow-y-auto pr-1">
                  {spreadsheets.length === 0 ? (
                    <p className="text-sm text-slate-400 italic p-2 text-center bg-slate-50 rounded">Belum ada daftar link.</p>
                  ) : (
                    spreadsheets.map((sheet) => (
                      <div key={sheet.id} className="flex justify-between items-center p-1.5 bg-green-50 rounded-lg border border-green-200 group transition-all">
                        <div className="flex items-center gap-3 overflow-hidden flex-1">
                          <button 
                            onClick={() => openLink(sheet.url, sheet.name)}
                            className="text-left flex flex-col min-w-0 flex-1 px-2 py-1.5 hover:bg-green-100 rounded-md transition-colors"
                            title={`Buka ${sheet.name} & Catat Log Akses`}
                          >
                            <span className="text-sm font-medium text-green-800 truncate">{sheet.name}</span>
                            <span className="text-xs text-green-600 truncate">{sheet.url}</span>
                          </button>
                        </div>
                        
                        {/* Tombol Aksi */}
                        <div className="flex items-center space-x-1 ml-2">
                           <button 
                              onClick={() => handleCopyLink(sheet.url, sheet.id)}
                              className={`p-1.5 text-green-500 rounded transition-colors ${
                                copiedLink === sheet.id 
                                  ? 'bg-green-600 text-white' 
                                  : 'hover:text-blue-600 hover:bg-blue-100'
                              }`}
                              title={copiedLink === sheet.id ? 'Tersalin!' : 'Salin Link'}
                            >
                              <Copy size={14} />
                            </button>
                            <button 
                              onClick={() => handleDeleteSpreadsheet(sheet.id)}
                              className="p-1.5 text-green-500 hover:text-red-600 hover:bg-red-100 rounded transition-colors"
                              title="Hapus Link"
                            >
                              <X size={14} />
                            </button>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>

              {/* Form Tambah Link */}
              <div className="p-4 border-t border-slate-100 bg-slate-50">
                <h4 className="text-sm font-medium text-slate-700 mb-3 flex items-center gap-1">
                  <Plus size={14} /> Tambah Link Baru
                </h4>
                <form onSubmit={handleAddSpreadsheet} className="space-y-3">
                  <div>
                    <input 
                      type="text" 
                      placeholder="Nama Galian (Contoh: Blok C)" 
                      value={newLinkName}
                      onChange={(e) => setNewLinkName(e.target.value)}
                      className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                      required
                    />
                  </div>
                  <div>
                    <input 
                      type="url" 
                      placeholder="URL Spreadsheet" 
                      value={newLinkUrl}
                      onChange={(e) => setNewLinkNameUrl(e.target.value)}
                      className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                      required
                    />
                  </div>
                  <button 
                    type="submit" 
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-medium transition-colors flex justify-center items-center gap-2"
                  >
                    <Plus size={16} /> Tambah Link
                  </button>
                </form>
              </div>
            </div>
          </div>

          {/* Kolom Kanan: Rekap Status Pengisian Bulanan */}
          <div className="lg:col-span-2">
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full min-h-[500px]">
              <div className="p-5 border-b border-slate-100 flex flex-col gap-4">
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h2 className="font-semibold text-slate-800 flex items-center gap-2">
                            <CalendarDays size={20} className="text-slate-500"/> Rekap Data Galian ({CURRENT_YEAR})
                        </h2>
                        <p className="text-sm text-slate-500">
                            Data diambil langsung dari Spreadsheet yang telah dibagikan publik.
                        </p>
                    </div>
                    
                    {/* Tombol Refresh */}
                    <button 
                        onClick={fetchMonthlyData}
                        disabled={isLoading}
                        className="flex items-center justify-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors shadow sm:w-auto w-full disabled:bg-blue-300"
                        title="Perbarui Data Live"
                    >
                        {isLoading ? <Loader size={16} className="animate-spin" /> : <RefreshCw size={16} />} 
                        {isLoading ? 'Memuat Live Data...' : 'Refresh Live Data'}
                    </button>
                </div>

                {/* Tombol CSV */}
                <button 
                    onClick={downloadCSV}
                    className="flex items-center justify-center sm:justify-start gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors w-full sm:w-auto"
                  >
                    <Download size={16} />
                    CSV Lengkap Rekap Tahun {CURRENT_YEAR}
                </button>
              </div>
              
              {/* Tombol Scroll Horizontal */}
              <div className="flex justify-between items-center px-5 pt-3 pb-2 border-b border-slate-100">
                <h3 className="font-semibold text-slate-700 text-sm">Tabel Detail Bulanan</h3>
                <div className="flex gap-2">
                    <button
                        onClick={() => handleScroll('left')}
                        className="p-2 bg-slate-100 text-slate-700 rounded-full shadow-sm hover:bg-slate-200 transition-colors disabled:opacity-50"
                        title="Scroll Kiri"
                    >
                        <ChevronLeft size={16} />
                    </button>
                    <button
                        onClick={() => handleScroll('right')}
                        className="p-2 bg-slate-100 text-slate-700 rounded-full shadow-sm hover:bg-slate-200 transition-colors disabled:opacity-50"
                        title="Scroll Kanan"
                    >
                        <ChevronRight size={16} />
                    </button>
                </div>
              </div>


              <div ref={tableContainerRef} className="overflow-x-auto flex-1 relative">
                {isLoading ? (
                    <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/70 z-30">
                        <Loader size={36} className="text-blue-500 animate-spin mb-4" />
                        <p className="text-lg font-medium text-blue-600">Memuat Live Data Galian...</p>
                        <p className="text-sm text-slate-500 mt-1">Memproses dari Google Sheets (Gviz).</p>
                    </div>
                ) : (
                    <table className="w-full text-left text-sm border-collapse">
                      <thead className="text-slate-600 font-medium border-b border-slate-200 sticky top-0 z-10">
                        {/* Header Baris 1: Kolom Pengelompokan dan Nama Bulan */}
                        <tr>
                          <th rowSpan={2} className="px-3 py-3 w-40 sticky left-0 bg-slate-50 border-r border-slate-200 z-20 whitespace-nowrap">Lokasi Galian</th>
                          <th rowSpan={2} className="px-3 py-3 text-center whitespace-nowrap bg-blue-50 border-r border-slate-200">Jenis Galian</th>
                          <th rowSpan={2} className="px-3 py-3 text-center whitespace-nowrap bg-blue-100 border-r border-slate-200">Total Volume (Ton)</th>
                          <th rowSpan={2} className="px-3 py-3 text-center whitespace-nowrap bg-blue-100 border-r border-slate-200">Total Nilai (IDR)</th>
                          {MONTHS.map(month => (
                            <th key={month} colSpan={2} className="px-3 py-3 text-center whitespace-nowrap border-r border-slate-200 bg-slate-50">
                              {month}
                            </th>
                          ))}
                        </tr>
                        {/* Header Baris 2: Kolom Volume dan Nilai */}
                        <tr>
                           {MONTHS.map(month => (
                               <React.Fragment key={`${month}-sub`}>
                                   <th className="px-2 py-2 text-center whitespace-nowrap border-r border-slate-100 bg-slate-100 text-xs text-green-700">Volume</th>
                                   <th className="px-2 py-2 text-center whitespace-nowrap border-r border-slate-200 bg-slate-100 text-xs text-indigo-700">Nilai (Rb)</th>
                               </React.Fragment>
                           ))}
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-100">
                        {monthlyRecap.length === 0 ? (
                          <tr>
                            <td colSpan={5 + MONTHS.length * 2} className="px-6 py-12 text-center text-slate-400">
                              Tidak ada lokasi galian yang terdaftar atau gagal memuat data.
                            </td>
                          </tr>
                        ) : (
                          monthlyRecap.map((recap, index) => {
                            
                            // Logika untuk menentukan gaya grup visual
                            const isOddGroup = recap.companyIndex % 2 !== 0;
                            const rowBgColor = isOddGroup ? 'bg-white' : 'bg-slate-50';
                            
                            // Cek apakah ini baris pertama dari grup perusahaan baru
                            const isFirstRowInGroup = index === 0 || monthlyRecap[index - 1].companyIndex !== recap.companyIndex;
                            const borderStyle = isFirstRowInGroup 
                                ? 'border-t-2 border-slate-300' // Garis tebal sebagai pemisah grup
                                : ''; 
                            
                            return (
                              <tr key={recap.id} className={`${rowBgColor} ${borderStyle} hover:bg-slate-100 transition-colors`}>
                                <td className={`px-3 py-3 font-medium text-slate-800 sticky left-0 ${rowBgColor} border-r border-slate-100 whitespace-nowrap`}>
                                  {recap.name}
                                </td>
                                <td className="px-3 py-3 text-center whitespace-nowrap text-slate-600 bg-blue-50 border-r border-slate-100">
                                  {recap.type}
                                </td>
                                {/* Total Kolom */}
                                <td className="px-3 py-3 text-center whitespace-nowrap font-bold bg-blue-100 text-green-700 border-r border-slate-100">
                                  {formatVolume(recap.totalVolume)}
                                </td>
                                <td className="px-3 py-3 text-center whitespace-nowrap font-bold bg-blue-100 text-indigo-700 border-r border-slate-200">
                                  {formatRupiah(recap.totalNilai)}
                                </td>

                                {MONTHS.map(month => {
                                  const data = recap.monthlyData[`${month} ${CURRENT_YEAR}`] || { status: 'Belum Ada Data', volume: 0, nilai: 0 };
                                  
                                  // LOGIC: Tentukan apakah data sudah disubmit atau belum.
                                  // Jika sudah disubmit (status 'Sudah'), tampilkan nilai (termasuk 0).
                                  // Jika belum, tampilkan '-'.
                                  const isDataSubmitted = data.status === 'Sudah';

                                  return (
                                    <React.Fragment key={`${recap.id}-${month}`}>
                                      {/* Kolom Volume */}
                                      <td className="px-1 py-3 text-center whitespace-nowrap border-r border-slate-100">
                                        {isDataSubmitted ? (
                                          <span 
                                            className={`inline-block w-full py-1 rounded text-xs font-medium text-green-800`}
                                            title={`Volume: ${formatVolume(data.volume)} Ton`}
                                          >
                                            {formatVolume(data.volume)} 
                                          </span>
                                        ) : (
                                          <span className="inline-block w-full py-1 rounded text-xs font-medium text-slate-400">
                                            - 
                                          </span>
                                        )}
                                      </td>
                                      
                                      {/* Kolom Nilai */}
                                      <td className="px-1 py-3 text-center whitespace-nowrap border-r border-slate-200">
                                        {isDataSubmitted ? (
                                          <span 
                                            className={`inline-block w-full py-1 rounded text-xs font-medium text-indigo-800`}
                                            title={`Nilai: ${formatRupiah(data.nilai * 1000)}`} 
                                          >
                                            {formatNilaiRb(data.nilai)} 
                                          </span>
                                        ) : (
                                          <span className="inline-block w-full py-1 rounded text-xs font-medium text-slate-400">
                                            - 
                                          </span>
                                        )}
                                      </td>
                                    </React.Fragment>
                                  );
                                })}
                              </tr>
                            );
                          })
                        )}
                      </tbody>
                    </table>
                )}
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  );
}
